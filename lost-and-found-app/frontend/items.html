<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <title>å¤±ç‰©ä¿¡æ¯åˆ—è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .comment-box {
      margin-top: 10px;
      padding-left: 1rem;
      border-left: 2px solid #ddd;
    }

    .comment {
      margin-bottom: 8px;
    }

    img.item-image {
      max-width: 200px;
      margin-top: 10px;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body class="bg-light">
  <div class="container mt-5">
    <h2 class="text-center mb-4">æ‰€æœ‰å¤±ç‰© / æ‹›é¢†ä¿¡æ¯</h2>
    <div id="loading" class="text-center text-secondary mb-3">æ­£åœ¨åŠ è½½ä¸­...</div>
    <ul id="itemlist" class="list-group shadow-sm"></ul>
    <br />
    <div class="text-center">
      <a href="report.html" class="btn btn-primary">å‘å¸ƒæ–°ä¿¡æ¯</a>
    </div>
  </div>

  <script>
    async function loadItems() {
      const loading = document.getElementById("loading");
      const list = document.getElementById("itemlist");
      const currentUser = localStorage.getItem("username");

      try {
        const res = await fetch("http://127.0.0.1:8002/items");
        const data = await res.json();

        if (!data.items || data.items.length === 0) {
          loading.innerText = "æš‚æ— å¤±ç‰©ä¿¡æ¯~";
          return;
        }

        loading.remove();

        data.items.forEach(item => {
          const li = document.createElement("li");
          li.classList.add("list-group-item");
          const typeLabel = item.type === "lost" 
            ? '<span class="badge bg-danger me-2">âŒ å¤±ç‰©</span>' 
            : '<span class="badge bg-success me-2">âœ… æ‹›é¢†</span>';

          li.innerHTML = `
            ${typeLabel}<strong>${item.name}</strong> - ${item.description}<br/>
            <span class="text-muted">${item.location}ï¼Œ${item.date}</span><br/>
            <small class="text-secondary">å‘å¸ƒè€…ï¼š${item.reported_by}</small><br/>
            ${item.image ? `<img src="http://127.0.0.1:8002/uploads/${item.image}" alt="ç‰©å“å›¾ç‰‡" class="item-image">` : ''}
            <br/>
            <button class="btn btn-link btn-sm" onclick="toggleComments(${item.id})">ğŸ’¬ æ˜¾ç¤º/éšè—è¯„è®º</button>
            <div class="comment-box" id="comments-${item.id}" style="display: none;"></div>
            <div class="mt-2">
              <textarea id="comment-${item.id}" class="form-control form-control-sm" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
              <button class="btn btn-outline-secondary btn-sm mt-1" onclick="submitComment(${item.id})">å‘é€</button>
            </div>
            ${item.reported_by === currentUser ? `
              <button class="btn btn-sm btn-outline-danger mt-2 me-1" onclick="deleteItem(${item.id})">ğŸ—‘ åˆ é™¤</button>
              <button class="btn btn-sm btn-outline-primary mt-2" onclick="window.location.href='edit.html?id=${item.id}'">âœ ä¿®æ”¹</button>
            ` : ''}
          `;

          list.appendChild(li);
        });

      } catch (error) {
        loading.innerText = "åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨æ˜¯å¦å¼€å¯";
        console.error("åŠ è½½é”™è¯¯ï¼š", error);
      }
    }


    async function toggleComments(itemId) {
      const commentBox = document.getElementById(`comments-${itemId}`);
      if (commentBox.style.display === "none") {
        const res = await fetch(`http://127.0.0.1:8002/items/${itemId}/comments`);
        const data = await res.json();
        commentBox.innerHTML = "";

        data.comments.forEach(c => {
          const div = document.createElement("div");
          div.classList.add("comment");
          div.innerHTML = `
            <strong>${c.commenter}</strong>: 
            <span id="content-${c.id}">${c.content}</span> 
            <small class="text-muted">(${new Date(c.time).toLocaleString()})</small>
            ${c.commenter === localStorage.getItem("username") ? `
              <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteComment(${itemId}, ${c.id})">åˆ é™¤</button>
              <button class="btn btn-sm btn-outline-primary ms-1" onclick="editComment(${itemId}, ${c.id}, '${c.content.replace(/'/g, "\\'")}')">ç¼–è¾‘</button>
            ` : ''}
          `;

          commentBox.appendChild(div);
        });

        commentBox.style.display = "block";
      } else {
        commentBox.style.display = "none";
      }
    }

    async function submitComment(itemId) {
      const token = localStorage.getItem("token");
      const textarea = document.getElementById(`comment-${itemId}`);
      const content = textarea.value.trim();

      if (!token) {
        alert("è¯·å…ˆç™»å½•ï¼");
        window.location.href = "login.html";
        return;
      }

      if (!content) {
        alert("è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
        return;
      }

      const res = await fetch(`http://127.0.0.1:8002/items/${itemId}/comments`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ content })
      });

      if (res.ok) {
        alert("è¯„è®ºæˆåŠŸï¼");
        textarea.value = "";
        toggleComments(itemId); // é‡æ–°åŠ è½½è¯„è®º
      } else {
        alert("è¯„è®ºå¤±è´¥ï¼");
      }
    }

    async function deleteItem(itemId) {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("è¯·å…ˆç™»å½•ï¼");
        return;
      }

      if (!confirm("ç¡®å®šè¦åˆ é™¤è¯¥ä¿¡æ¯å—ï¼Ÿ")) return;

      const res = await fetch(`http://127.0.0.1:8002/items/${itemId}`, {
        method: "DELETE",
        headers: {
          "Authorization": "Bearer " + token
        }
      });

      if (res.ok) {
        alert("âœ… åˆ é™¤æˆåŠŸï¼");
        window.location.reload();
      } else {
        const data = await res.json();
        alert(data.detail || "âŒ åˆ é™¤å¤±è´¥ï¼");
      }
    }

    function editItem(itemId) {
      window.location.href = `edit.html?id=${itemId}`;
    }

    window.onload = loadItems;

    async function deleteComment(itemId, commentId) {
      const token = localStorage.getItem("token");
      if (!confirm("ç¡®å®šåˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ")) return;
      const res = await fetch(`http://127.0.0.1:8002/items/${itemId}/comments/${commentId}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });
      if (res.ok) {
        alert("è¯„è®ºå·²åˆ é™¤");
        toggleComments(itemId);
      } else {
        alert("åˆ é™¤å¤±è´¥");
      }
    }

    async function editComment(itemId, commentId, oldContent) {
      const newContent = prompt("ä¿®æ”¹è¯„è®ºï¼š", oldContent);
      if (!newContent || newContent.trim() === "") return;

      const token = localStorage.getItem("token");
      const res = await fetch(`http://127.0.0.1:8002/items/${itemId}/comments/${commentId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ content: newContent })
      });

      if (res.ok) {
        alert("è¯„è®ºä¿®æ”¹æˆåŠŸ");
        toggleComments(itemId);
      } else {
        alert("è¯„è®ºä¿®æ”¹å¤±è´¥");
      }
    }
  </script>

</body>

</html>
